---
import Placeholder from "../assets/icons/Placeholder.astro";
import Button from "./Button.astro";
import type { SliderPostCardProps } from "@src-types/types";
import { slugify } from "../utils/presentation.ts";
import { resolveImagePath } from "../utils/assets.ts";
import { Image } from "astro:assets";

const t = Astro.props.t;
const globalSettings = Astro.props.globalSettings;

const {
    content_position = "Bottom Left",
    content_length = "Narrow",
    button_style = globalSettings.button_style_on_background_media,
    index,
    total_posts,
    post
} = Astro.props as SliderPostCardProps;

// Display settings with defaults
const shows = post.data.show_topics_on_home ?? false; // default off
const showReadStoryLink = post.data.show_read_story_link ?? false; // default off
const showExcerpt = post.data.show_excerpt_on_home ?? true; // default on

const topics = (post.data.topics || [])
  .slice(0, 2)
  .map(topicName => ({
    name: topicName,
    slug: slugify(topicName)
}));

const processedImage = resolveImagePath(post.data.feature_image);

const video_glob = import.meta.glob('@assets/*.{mp4,webm,mov}', { eager: true });

const feature_video_filename = post.data.feature_video
  ? post.data.feature_video.split('/').pop()!
  : null;

const feature_video_item = feature_video_filename
  ? Object.entries(video_glob).find(([key, _]) =>
      key.endsWith(feature_video_filename)
    )
  : null;

const feature_video = feature_video_item ? (feature_video_item[1] as any).default : null;
---

<div 
    class="slide background-media"
    role="group"
    aria-roledescription="Slide"
    aria-label=`${index + 1} of ${total_posts}`
    data-slide-number={index + 1}
    data-slug={post.id}
>
    <div class:list={['wide-container', { 'hero-center': content_position == "Center" }]}>
        <div class="hero-content">
            <div class="hero-content-inner">
                <div class="hero-text-content">
                    {shows && topics.length > 0 && (
                        <div class="topics-wrapper slide-ease-in-animation">
                           {topics.map(topic => (
                                <a href={`/topics/${topic.slug}`} class="bracket-button">
                                    <div class="medium-text left-bracket">{t.global.bracket}</div>
                                    <div class="bracket-button-text">
                                        <div class="medium-text main">{topic.name}</div>
                                        <div class="medium-text absolute">{topic.name}</div>
                                    </div>
                                    <div class="medium-text right-bracket">{t.global.bracket}</div>
                                </a>
                            ))}
                        </div>
                    )}
                    <a href={`/blog/${post.id}`} class="heading-1-wrapper slide-ease-in-animation" data-content-length={content_length}>
                        <h1>{post.data.title}</h1>
                    </a>

                    {showExcerpt && post.data.excerpt && (
                        <div class="post-summary-wrapper slide-ease-in-animation">
                            <p class="paragraph overlay">{post.data.excerpt}</p>
                        </div>
                    )}
                </div>

                {showReadStoryLink && (
                    <Button t={t} text={t.global.read_story} button_style={button_style} classname="slide-ease-in-animation" url={`/blog/${post.id}`}/>
                )}
            </div>
        </div>
    </div>

    <div class="background-image slide-image-animation">
         {feature_video ? (
                <video loop autoplay muted playsinline>
                    <source src={feature_video} type="video/mp4" />
                </video>
            ) : (
                <>
                    {post.data.feature_image ? (                 
                        <figure class="parallax-image parallax-image-mobile">
                            <Image 
                                src={processedImage} 
                                alt={post.data.title}
                    inferSize={true}
                                loading="lazy" 
                                format="webp"
                                widths={[300, 400, 600, 800, 1000, 1200, 1600, 2000, 2400, 2800, 3200, 3600, 4200]}
                                sizes="100vw"
                            />
                        </figure>                       
                    ) : (
                        <div class="placeholder flex-center">
                            <Placeholder/>
                        </div>               
                    )}
                </>
            )
        }
        <div class="dark-overlay"></div>
    </div>
</div>