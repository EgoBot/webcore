---
import Placeholder from "../assets/icons/Placeholder.astro";
import Button from "./Button.astro";
import PostAuthors from "./PostAuthors.astro";
import { slugify } from "../utils/presentation.ts";
import { resolveImagePath } from "../utils/assets.ts";
import { Image } from "astro:assets";
import type { BackgroundMediaPostHeaderProps } from "@src-types/types";

import "@styles/hero-section.css";

const t = Astro.props.t;
const globalSettings = Astro.props.globalSettings;

const {
    content_position = globalSettings.content_position_on_home_hero,
    content_length = globalSettings.content_length_on_background_media,
    button_style = globalSettings.button_style_on_background_media,
    post,
    is_for_end_page = false,
    minutes_read,
    showsOnPost,
    showAuthorReadTime
} = Astro.props as BackgroundMediaPostHeaderProps;

// Display settings with defaults
const shows = is_for_end_page
  ? (showsOnPost ?? false)
  : (post.data.show_topics_on_home ?? false);

const showReadStoryLink = is_for_end_page
  ? false // Never show read story link on post page
  : (post.data.show_read_story_link ?? false);

const showExcerpt = is_for_end_page
  ? true // Always show excerpt on post page (controlled by PostAuthors component)
  : (post.data.show_excerpt_on_home ?? true);

const showAuthorInfo = is_for_end_page && (showAuthorReadTime ?? false);

const topics = (post.data.topics || [])
  .slice(0, 2)
  .map(topicName => ({
    name: topicName,
    slug: slugify(topicName)
}));

// DEBUG: Log all flags and data
console.log('=== BACKGROUND MEDIA POST HEADER DEBUG ===');
console.log('First post:', first_post);
console.log('First post data keys:', Object.keys(first_post.data));
console.log('show_topics_on_home value:', first_post.data.show_topics_on_home);
console.log('Post ID:', post.id);
console.log('Post Title:', post.data.title);
console.log('show_topics_on_home:', post.data.show_topics_on_home);
console.log('show_read_story_link:', post.data.show_read_story_link);
console.log('show_excerpt_on_home:', post.data.show_excerpt_on_home);
console.log('topics array:', post.data.topics);
console.log('topics (mapped):', topics);
console.log('shows variable:', shows);
console.log('showReadStoryLink:', showReadStoryLink);
console.log('showExcerpt:', showExcerpt);
console.log('Condition (shows && topics.length > 0):', shows && topics.length > 0);
console.log('==========================================');

const processedImage = resolveImagePath(post.data.feature_image);

const video_glob = import.meta.glob('@assets/*.{mp4,webm,mov}', { eager: true });

const feature_video_filename = post.data.feature_video
  ? post.data.feature_video.split('/').pop()!
  : null;

const feature_video_item = feature_video_filename
  ? Object.entries(video_glob).find(([key, _]) =>
      key.endsWith(feature_video_filename)
    )
  : null;

const feature_video = feature_video_item ? (feature_video_item[1] as any).default : null;
---
<section class:list={['background-media hero-section', { 'hero-center': content_position == "Center" }]}>
    <div class="wide-container">
        <div class="hero-content">
            <div class="hero-content-inner">
                <div class="hero-text-content">
                    {shows && topics.length > 0 && (
                        <div class:list={['topics-wrapper', { 'ease-in-animation': globalSettings.use_page_load_animations }]}>
                            {topics.map(topic => (
                                <a href={`/topics/${topic.slug}`} class="bracket-button">
                                    <div class="medium-text left-bracket">{t.global.bracket}</div>
                                    <div class="bracket-button-text">
                                        <div class="medium-text main">{topic.name}</div>
                                        <div class="medium-text absolute">{topic.name}</div>
                                    </div>
                                    <div class="medium-text right-bracket">{t.global.bracket}</div>
                                </a>
                            ))}
                        </div>
                    )}

                    {is_for_end_page ? (
                        <>
                            <div class:list={['heading-1-wrapper', { 'ease-in-animation': globalSettings.use_page_load_animations }]} data-content-length={content_length}>
                                <h1>{post.data.title}</h1>
                            </div>

                            <div class:list={['excerpt-and-authors', { 'ease-in-animation': globalSettings.use_page_load_animations }]}>
                                {showExcerpt && post.data.excerpt && (
                                    <div class="post-summary-wrapper">
                                        <p class="paragraph overlay">{post.data.excerpt}</p>
                                    </div>
                                )}

                                {showAuthorInfo && (
                                    <PostAuthors post={post} minutes_read={minutes_read}/>
                                )}
                            </div>
                        </>
                    ) : (
                        <>
                            <a href={`/blog/${post.id}`} class:list={['heading-1-wrapper', { 'ease-in-animation': globalSettings.use_page_load_animations }]} data-content-length={content_length}>
                                <h1>{post.data.title}</h1>
                            </a>

                            {showExcerpt && post.data.excerpt && (
                                <div class:list={['post-summary-wrapper', { 'ease-in-animation': globalSettings.use_page_load_animations }]}>
                                    <p class="paragraph overlay">{post.data.excerpt}</p>
                                </div>
                            )}
                        </>
                    )}
                </div>

                {is_for_end_page ? (
                    <></>
                ) : showReadStoryLink ? (
                    <div class:list={['', { 'ease-in-animation': globalSettings.use_page_load_animations }]}>
                        <Button t={t} text={t.global.read_story} button_style={button_style} url={`/blog/${post.id}`}/>
                    </div>
                ) : null}
            </div>
        </div>
    </div>
    <div class:list={['background-image', { 'image-animation': globalSettings.use_page_load_animations }]}>
        {feature_video ? (
                <video loop autoplay muted playsinline>
                    <source src={feature_video} type="video/mp4" />
                </video>
            ) : (
                <>
                    {post.data.feature_image ? (                 
                        <figure class="parallax-image">
                            <Image 
                                src={processedImage} 
                                alt={post.data.title}
                    inferSize={true}
                                loading="lazy" 
                                format="webp"
                                widths={[300, 400, 600, 800, 1000, 1200, 1600, 2000, 2400, 2800, 3200, 3600, 4200]}
                                sizes="100vw"
                            />
                        </figure>                       
                    ) : (
                        <div class="placeholder flex-center">
                            <Placeholder/>
                        </div>               
                    )}
                </>
            )
        }
        <div class="dark-overlay"></div>
    </div>
</section>